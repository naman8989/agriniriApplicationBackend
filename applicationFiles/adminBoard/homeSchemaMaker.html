<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Layout Builder Drag & Drop</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>

  <style>
    body { background: #f5f7fa; }
    .layout-box {
      background: #fff;
      border: 2px solid #007bff;
      border-radius: 10px;
      padding: 10px 15px;
      margin-bottom: 10px;
    }
    .layout-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-weight: 600;
      color: #007bff;
      cursor: grab;
    }
    .delete-btn {
      background: #dc3545;
      color: white;
      border: none;
      border-radius: 5px;
      padding: 3px 8px;
      cursor: pointer;
    }
    
    .item-box {
      background: #e9f5ff;
      padding: 5px 8px;
      border-radius: 5px;
      margin: 5px 0;
      font-size: 0.9rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: grab;
      overflow: hidden;       /* <-- Add this line */
      text-overflow: ellipsis; /* Optional visual polish */
    }


    .builder-form { 
      background: #fff; 
      padding: 15px; 
      border-radius: 10px; 
      margin-bottom: 20px; 
      border: 2px solid #007bff; 
    }
  </style>
</head>
<body class="p-4" onload="loadLayout()">
  <!-- Shared Navbar -->
<nav class="navbar navbar-expand-lg navbar-dark bg-dark mb-4">
  <div class="container-fluid">
    <a class="navbar-brand fw-bold" href="#">Product Manager</a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div class="collapse navbar-collapse" id="navbarNav">
      <ul class="navbar-nav ms-auto">
        <li class="nav-item">
          <a class="nav-link" href="adminHomeSchema">üè† Home Schema</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="addProduct">‚ûï Add Product</a>
        </li>
      </ul>
    </div>
  </div>
</nav>

  <div class="container">
    <h2 class="text-center mb-4">üèóÔ∏è Homepage Layout Builder</h2>
    <div class="row mb-4">
      <div class="col-md-4">
        <h5>üß© Select Builder</h5>
        <button class="btn btn-primary mb-2 w-100" onclick="showForm('carouselBanners')">Carousel Banner</button>
        <button class="btn btn-success mb-2 w-100" onclick="showForm('banners')">Banner</button>
        <button class="btn btn-warning mb-2 w-100" onclick="showForm('iconSlideshow')">Icon Slideshow</button>
        <button class="btn btn-info mb-2 w-100" onclick="showForm('gridList')">Grid List</button>
      </div>
      <div class="col-md-8">
        <h5>‚öôÔ∏è Builder Form</h5>
        <div id="builderForm" class="builder-form"><p class="text-muted">Select a builder to show form.</p></div>
      </div>
    </div>
    <h5>üìÑ Current Layout</h5>
    <div id="layoutArea" class="mb-3" style="min-height: 150px;">
      <p class="text-muted text-center" id="emptyText">No sections added yet.</p>
    </div>
    <button class="btn btn-secondary mb-2" onclick="loadLayout()">üì• Load Data</button>
    <button class="btn btn-dark mb-3" onclick="updateLayout()">üíæ Update Layout</button>
    <pre id="output" class="bg-light p-2 rounded"></pre>
  </div>
  <!-- Product Selection Modal -->
  <div class="modal fade" id="productModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Select Product(s)</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body" id="productList" style="max-height: 60vh; overflow-y: auto;">
          <p class="text-muted text-center">Loading products...</p>
        </div>
        <div class="modal-footer">
          <button class="btn btn-primary" id="confirmSelectionBtn">Confirm Selection</button>
        </div>
      </div>
    </div>
  </div>


  <script>
    let layout = [];
    let currentBuilderType = null;

    const sectionSortable = new Sortable(document.getElementById('layoutArea'), {
      animation: 150,
      handle: '.layout-header',
      onEnd: function() {
        const layoutArea = document.getElementById('layoutArea');
        const newLayout = [];
        layoutArea.querySelectorAll('.layout-box').forEach(box => {
          const sec = layout.find(s => s.id === box.id);
          if (sec) newLayout.push(sec);
        });
        layout = newLayout;
      }
    });

    function showForm(type) {
      currentBuilderType = type;
      const form = document.getElementById("builderForm");
      form.innerHTML = "";
      if(type==='carouselBanners' || type==='banners'){
        form.innerHTML = `
          <input class="form-control mb-2" placeholder="Text">
          <input type="color" class="form-control mb-2" placeholder="Color" value="#81C784">
          <input class="form-control mb-2" type="number" placeholder="Height">
          <input class="form-control mb-2" type="file" accept="image/*" id="imageInput">
          <button class="btn btn-primary" onclick="addItem()">Add Item</button>
        `;
      } else if(type==='iconSlideshow'){
        const iconOptions = `
          <option value="0xe3af,Icons.home">home (0xe3af)</option>
          <option value="0xe87c,Icons.favorite">favorite (0xe87c)</option>
          <option value="0xe0be,Icons.shopping_cart">shopping_cart (0xe0be)</option>
          <option value="0xe55f,Icons.settings">settings (0xe55f)</option>
        `;
        form.innerHTML = `
          <input class="form-control mb-2" placeholder="Label">
          <select class="form-control mb-2" id="iconSelect">
            <option value="">-- Select Icon --</option>
            ${iconOptions}
          </select>
          <button class="btn btn-primary" onclick="addItem()">Add Icon</button>
        `;
      } else if(type==='gridList'){
        form.innerHTML = `
          <input class="form-control mb-2" placeholder="Title">
          <input class="form-control mb-2" type="number" placeholder="Count">
          <input class="form-control mb-2" type="number" placeholder="CrossAxisCount">
          <button class="btn btn-primary mb-2" onclick="addGrid()">Add Grid</button>
          <button class="btn btn-success" onclick="getProduct()">Get Product</button>
        `;
      }
    }

    async function imageToBlob(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onloadend = () => {
          const arrayBuffer = reader.result;
          const bytes = new Uint8Array(arrayBuffer);
          resolve(Array.from(bytes));
        };
        reader.onerror = reject;
        reader.readAsArrayBuffer(file);
      });
    }

    async function addItem(){
      const inputs = document.querySelectorAll("#builderForm input, #builderForm select");
      const sectionId = currentBuilderType + "_section";
      let section = layout.find(s => s.id === sectionId);
      if(!section){
        section = { id: sectionId, type: currentBuilderType, items: [] };
        layout.push(section);
        renderSection(section);
      }

      const itemId = Date.now();
      let item = {};
      if(currentBuilderType==='carouselBanners' || currentBuilderType==='banners'){
        const text = inputs[0].value;
        const hexColor = inputs[1].value;
        const heightVal = parseFloat(inputs[2].value);
        const imageFile = document.getElementById('imageInput').files[0];
        let imageBlob = null;
        if(imageFile) {
          imageBlob = await imageToBlob(imageFile);
        }
        const colourInt = parseInt("0xFF" + hexColor.substring(1));
        item = { itemId, text: text, color: colourInt, height: heightVal, imageBlob: imageBlob };
      } else if(currentBuilderType==='iconSlideshow'){
        const label = inputs[0].value;
        const sel = document.getElementById("iconSelect");
        const val = sel.value;
        if(!val){
          alert("Please select an icon");
          return;
        }
        const parts = val.split(",");
        const codePoint = parseInt(parts[0], 16);
        const fontFamily = "MaterialIcons";
        item = { itemId, label: label, codePoint: codePoint, fontFamily: fontFamily };
      }
      section.items.push(item);
      renderItems(section);
      inputs.forEach(i => {
        if(i.tagName.toLowerCase()==="input") i.value = "";
        if(i.tagName.toLowerCase()==="select") i.selectedIndex = 0;
      });
    }

    function addGrid(){
      const inputs = document.querySelectorAll("#builderForm input");
      const sectionId = currentBuilderType + "_section";
      let section = layout.find(s => s.id === sectionId);

      if(!section){
        section = { id: sectionId, type: currentBuilderType, items: [] };
        layout.push(section);
        renderSection(section);
      }

      if(tempSelectedProducts.length === 0){
        alert("Please select at least one product!");
        return;
      }

      const itemId = Date.now();
      const title = inputs[0].value || "Grid Section"; // keep title optional
      const crossAxisCount = parseInt(inputs[1].value) || 2; // default if left empty

      // Each selected product becomes its own grid item
      const gridItems = tempSelectedProducts.map(p => ({
        itemId: Date.now() + Math.floor(Math.random() * 1000), // unique id
        productName: p.productName || "Unnamed Product",
        productQuantityAvaliable: p.productQuantityAvaliable || 0,
        productImage: p.productImage || null,
        type: "selectedProduct"
      }));

      const gridObj = {
        itemId,
        title,
        crossAxisCount,
        items: gridItems
      };

      section.items.push(gridObj);
      renderItems(section);

      // Clear inputs & temp products
      inputs.forEach(i => i.value = "");
      tempSelectedProducts = [];
      const previewDiv = document.getElementById("selectedProductsPreview");
      if(previewDiv) previewDiv.remove();
    }


    async function getProduct() {
      try {
        const res = await fetch('/graphql-data', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            query: `mutation {
              operateAllUserData(operation: "read", input: [{ userProductInfo: { live: "yes" } }]) {
                userProductInfo {
                  farmerUniqueId productId productName productPrice productDesc
                  productRating locationDetail productImage productQuantityAvaliable
                  productQuantityUsed minOrderReq MultipleOrderRequest live response status
                }
              }
            }`
          })
        });

        const json = await res.json();
        const products = json?.data?.operateAllUserData?.[0]?.userProductInfo || [];

        if (!products.length) {
          alert("No live products found!");
          return;
        }

        showProductPopup(products);
      } catch (err) {
        console.error("Error fetching products:", err);
        alert("Failed to fetch products!");
      }
    }

    function showProductPopup(products) {
      const listDiv = document.getElementById("productList");
      listDiv.innerHTML = "";

      products.forEach((p, index) => {
        let imgSrc = "https://via.placeholder.com/80x80?text=No+Image";
        if (Array.isArray(p.productImage)) {
          const blob = new Blob([new Uint8Array(p.productImage)], { type: "image/jpeg" });
          imgSrc = URL.createObjectURL(blob);
        }

        const card = document.createElement("div");
        card.className = "d-flex align-items-center border rounded p-2 mb-2";
        card.innerHTML = `
          <input type="checkbox" class="form-check-input me-3 product-select" data-index="${index}">
          <img src="${imgSrc}" width="80" height="80" class="rounded me-3" style="object-fit:cover;">
          <div style="flex:1;">
            <b>${p.productName || "Unnamed Product"}</b><br>
            <small class="text-muted">Available: ${p.productQuantityAvaliable || 0}</small>
          </div>
        `;
        listDiv.appendChild(card);
      });

      const modal = new bootstrap.Modal(document.getElementById("productModal"));
      modal.show();

      document.getElementById("confirmSelectionBtn").onclick = function () {
        const selectedIndexes = [...document.querySelectorAll(".product-select:checked")].map(
          cb => parseInt(cb.dataset.index)
        );
        tempSelectedProducts = selectedIndexes.map(i => products[i]);
        modal.hide();

        // Show selected products in the builder form
        const form = document.getElementById("builderForm");
        const preview = document.createElement("div");
        preview.id = "selectedProductsPreview";
        preview.innerHTML = tempSelectedProducts.map(p => `<div>${p.productName}</div>`).join("");
        form.appendChild(preview);
      };
    }



    function renderSection(section){
      const layoutArea = document.getElementById("layoutArea");
      document.getElementById("emptyText").style.display = "none";
      if(document.getElementById(section.id)) return;
      const div = document.createElement("div");
      div.className = "layout-box";
      div.id = section.id;
      div.innerHTML = `
        <div class="layout-header">
          <span>${getLabel(section.type)}</span>
          <button class="delete-btn" onclick="deleteSection('${section.id}')">Delete Section</button>
        </div>
        <div class="items-container mt-2"></div>
      `;
      layoutArea.appendChild(div);
    }

    function renderItems(section) {
      const container = document.querySelector(`#${section.id} .items-container`);
      container.innerHTML = "";

      section.items.forEach(item => {
        const div = document.createElement("div");
        div.className = "item-box";
        div.id = `item_${item.itemId}`;

        let previewHTML = "";
        if(item.items && Array.isArray(item.items)){ 
          // If grid section with selected products
          previewHTML = item.items.map(p => {
            let imgSrc = "https://via.placeholder.com/50x50?text=No+Image";
            if (Array.isArray(p.productImage)) {
              const blob = new Blob([new Uint8Array(p.productImage)], { type: "image/jpeg" });
              imgSrc = URL.createObjectURL(blob);
            }
            return `<div style="display:flex; align-items:center; gap:5px; margin-bottom:3px;">
                      <img src="${imgSrc}" width="50" height="50" style="object-fit:cover; border-radius:5px;">
                      <div>
                        <b>${p.productName}</b><br>
                        <small class="text-muted">Qty: ${p.productQuantityAvaliable}</small>
                      </div>
                    </div>`;
          }).join("");
        } else {
          // Single banner/item
          if (item.imageBlob && Array.isArray(item.imageBlob)) {
            const blob = new Blob([new Uint8Array(item.imageBlob)], { type: 'image/jpeg' });
            const imgURL = URL.createObjectURL(blob);
            previewHTML = `<img src="${imgURL}" style="max-height:60px; max-width:80px; object-fit:cover; border-radius:5px; margin-right:8px;">`;
          }
        }

        div.innerHTML = `
          <div style="display:flex; flex-direction:column;">
            <b>${item.title || item.text || item.label || "Item"}</b>
            <div>${previewHTML}</div>
          </div>
          <button class="delete-btn" onclick="deleteItem('${section.id}', ${item.itemId})">√ó</button>
        `;

        container.appendChild(div);
      });

      makeItemsSortable(section.id);
    }


    function makeItemsSortable(sectionId){
      const container = document.querySelector(`#${sectionId} .items-container`);
      new Sortable(container, {
        animation: 100,
        handle: '.item-box span',
        onEnd: function(){
          const section = layout.find(s => s.id === sectionId);
          if(!section) return;
          const newItems = [];
          container.querySelectorAll('.item-box').forEach(div => {
            const itemId = parseInt(div.id.replace('item_',''));
            const item = section.items.find(it => it.itemId === itemId);
            if(item) newItems.push(item);
          });
          section.items = newItems;
        }
      });
    }

    function deleteItem(sectionId, itemId){
      const section = layout.find(s => s.id === sectionId);
      if(!section) return;
      section.items = section.items.filter(it => it.itemId !== itemId);
      renderItems(section);
    }

    function deleteSection(id){
      layout = layout.filter(s => s.id !== id);
      document.getElementById(id)?.remove();
      if(layout.length === 0) document.getElementById("emptyText").style.display = "block";
    }

    function getLabel(type){
      switch(type){
        case "carouselBanners": return "üåÄ Carousel Banner";
        case "banners": return "üè∑Ô∏è Banner";
        case "iconSlideshow": return "üéûÔ∏è Icon Slideshow";
        case "gridList": return "üî≥ Grid List";
        default: return type;
      }
    }

    async function updateLayout() {
      // Clone layout safely
      const jsonLayout = {};

      for (const section of layout) {
        jsonLayout[section.type] = await Promise.all(section.items.map(async i => {
          const item = { ...i };
          if (item.imageBlob && Array.isArray(item.imageBlob)) {
            const blob = new Blob([new Uint8Array(item.imageBlob)], { type: 'image/jpeg' });
            const base64 = await blobToBase64(blob);
            item.imageBase64 = base64; // add new field
            delete item.imageBlob; // remove large array
          }
          return item;
        }));
      }

      document.getElementById("output").textContent = JSON.stringify(jsonLayout, null, 2);

      fetch('/adminHomeSchema', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ schema: jsonLayout })
      })
      .then(res => res.json())
      .then(data => alert("Layout updated successfully! "+ JSON.stringify(data['schema'])))
      .catch(err => console.error("Error updating layout:", err));
    }

    function blobToBase64(blob) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onloadend = () => resolve(reader.result.split(',')[1]);
        reader.onerror = reject;
        reader.readAsDataURL(blob);
      });
    }

    function base64ToBlob(base64, mimeType = "image/jpeg") {
      const byteChars = atob(base64);
      const byteNumbers = new Array(byteChars.length);
      for (let i = 0; i < byteChars.length; i++) {
        byteNumbers[i] = byteChars.charCodeAt(i);
      }
      const byteArray = new Uint8Array(byteNumbers);
      return new Blob([byteArray], { type: mimeType });
    }



    async function loadLayout() {
      fetch('/adminHomeSchema', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({})
      })
      .then(res => res.json())
      .then(async data => {
        console.log("Loaded layout data:", data);

        const layoutArea = document.getElementById("layoutArea");
        layoutArea.innerHTML = '<p class="text-muted text-center" id="emptyText">No sections added yet.</p>';
        document.getElementById("emptyText").style.display = "none";

        layout = [];

        for (const type of Object.keys(data)) {
          const sectionId = type + "_section";

          // Convert Base64 back to Blob
          for (const item of data[type]) {
            if (item.imageBase64) {
              try {
                const blob = base64ToBlob(item.imageBase64);
                const buffer = await blob.arrayBuffer();
                item.imageBlob = Array.from(new Uint8Array(buffer));
                delete item.imageBase64;
              } catch (err) {
                console.error("Error converting base64 to blob:", err);
              }
            }
          }

          const section = { id: sectionId, type: type, items: data[type] };
          layout.push(section);
          renderSection(section);
          renderItems(section);
        }

        if (layout.length === 0) {
          document.getElementById("emptyText").style.display = "block";
        }
      })
      .catch(err => console.error("Error loading layout:", err));
    }

  
  </script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

</body>
</html>
