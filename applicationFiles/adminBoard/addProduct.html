<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Farmer & Shopkeeper Portal</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    body { background: #f8f9fa; }
    .tab-content { margin-top: 20px; }
    #flashMessage {
      transition: opacity .3s ease;
      opacity: 0;
      visibility: hidden;
    }
    #flashMessage.show {
      opacity: 1;
      visibility: visible;
    }
  </style>
</head>
<body>
<div class="container py-5">
  <div class="card shadow-lg border-0 rounded-4">
    <div class="card-body">
      <h3 class="text-center mb-4 fw-bold">Farmer & Shopkeeper Operations</h3>

      <ul class="nav nav-tabs" id="mainTabs">
        <li class="nav-item">
          <button class="nav-link active" id="farmer-tab" data-bs-toggle="tab" data-bs-target="#farmerTab">Farmer - Add Product</button>
        </li>
        <li class="nav-item">
          <button class="nav-link" id="shop-tab" data-bs-toggle="tab" data-bs-target="#shopTab">Shopkeeper - Add Order</button>
        </li>
      </ul>

      <div id="flashMessage" class="alert text-center mt-3 fw-semibold"></div>

      <div class="tab-content">
        <!-- Farmer Tab -->
        <div class="tab-pane fade show active" id="farmerTab">
          <h5 class="mt-3">Add Product</h5>
          <form id="farmerForm" class="row g-3">
            <div class="col-md-4">
              <label class="form-label">Product ID</label>
              <input type="text" id="productId" class="form-control" placeholder="Product ID">
            </div>
            <div class="col-md-4">
              <label class="form-label">Product Name</label>
              <input type="text" id="productName" class="form-control" placeholder="Name">
            </div>
            <div class="col-md-4">
              <label class="form-label">Product Price</label>
              <input type="number" id="productPrice" class="form-control" placeholder="Price">
            </div>
            <div class="col-md-6">
              <label class="form-label">Description</label>
              <textarea id="productDesc" class="form-control"></textarea>
            </div>
            <div class="col-md-3">
              <label class="form-label">Rating</label>
              <input type="number" id="productRating" class="form-control">
            </div>
            <div class="col-md-3">
              <label class="form-label">Farmer Unique ID</label>
              <input type="text" id="farmerUniqueId" class="form-control">
            </div>
            <div class="col-md-3">
              <label class="form-label">Location</label>
              <input type="text" id="locationDetail" class="form-control">
            </div>
            <div class="col-md-3">
              <label class="form-label">Quantity Available</label>
              <input type="number" id="productQuantityAvaliable" class="form-control">
            </div>
            <div class="col-md-3">
              <label class="form-label">Quantity Used</label>
              <input type="number" id="productQuantityUsed" class="form-control">
            </div>
            <div class="col-md-3">
              <label class="form-label">Min Order Req</label>
              <input type="number" id="minOrderReq" class="form-control">
            </div>
            <div class="col-md-3">
              <label class="form-label">Multiple Order Request</label>
              <input type="number" id="MultipleOrderRequest" class="form-control">
            </div>
            <div class="col-md-3">
              <label class="form-label">Live</label>
              <input type="text" id="live" class="form-control">
            </div>
            <div class="col-md-12">
              <label class="form-label">Product Image (URL)</label>
              <input type="text" id="productImage" class="form-control">
            </div>
            <div class="col-12 d-flex gap-2 mt-3">
              <button type="button" class="btn btn-primary" onclick="submitFarmer('create')">Create Product</button>
              <button type="button" class="btn btn-success" onclick="submitFarmer('read')">Load Product</button>
              <button type="button" class="btn btn-warning" onclick="submitFarmer('update')">Update Product</button>
            </div>
          </form>
        </div>

        <!-- Shopkeeper Tab -->
        <div class="tab-pane fade" id="shopTab">
          <h5 class="mt-3">Add Order</h5>
          <form id="shopForm" class="row g-3">
            <div class="col-md-4">
              <label class="form-label">Order ID</label>
              <input type="text" id="orderId" class="form-control" placeholder="Order ID">
            </div>
            <div class="col-md-4">
              <label class="form-label">Shop Unique ID</label>
              <input type="text" id="shopUniqueId" class="form-control">
            </div>
            <div class="col-md-4">
              <label class="form-label">Payment ID</label>
              <input type="text" id="paymentId" class="form-control">
            </div>
            <div class="col-md-4">
              <label class="form-label">Total Amount</label>
              <input type="number" id="totalAmount" class="form-control">
            </div>
            <div class="col-md-4">
              <label class="form-label">Encouragement</label>
              <input type="text" id="accoragement" class="form-control">
            </div>
            <div class="col-md-4">
              <label class="form-label">Payment Status</label>
              <input type="text" id="paymentStatus" class="form-control">
            </div>
            <div class="col-md-4">
              <label class="form-label">Payment Method</label>
              <input type="text" id="paymentMethod" class="form-control">
            </div>
            <div class="col-md-4">
              <label class="form-label">Shipment Status</label>
              <input type="text" id="shipmentStatus" class="form-control">
            </div>
            <div class="col-md-4">
              <label class="form-label">Shipment Info</label>
              <input type="text" id="shipmentInfo" class="form-control">
            </div>
            <div class="col-md-4">
              <label class="form-label">Quantity Getting</label>
              <input type="number" id="quantityGetting" class="form-control">
            </div>
            <div class="col-md-4">
              <label class="form-label">Product ID</label>
              <input type="text" id="productId" class="form-control">
            </div>
            <div class="col-12 d-flex gap-2 mt-3">
              <button type="button" class="btn btn-primary" onclick="submitShop('create')">Create Order</button>
              <button type="button" class="btn btn-success" onclick="submitShop('read')">Load Order</button>
              <button type="button" class="btn btn-warning" onclick="submitShop('update')">Update Order</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
const flash = document.getElementById('flashMessage');

function showFlash(message, type='success', duration=2500) {
  flash.className = 'alert alert-' + type + ' text-center fw-semibold show';
  flash.textContent = message;
  setTimeout(()=> flash.classList.remove('show'), duration);
}

function getFormData(formId) {
  const form = document.getElementById(formId);
  const data = {};
  form.querySelectorAll('input, textarea').forEach(inp => {
    data[inp.id] = inp.value.trim();
  });
  return data;
}

function fillForm(formId, data) {
  const form = document.getElementById(formId);
  Object.entries(data).forEach(([key, val]) => {
    const field = form.querySelector(`#${key}`);
    if (field) field.value = val ?? '';
  });
}

// FARMER FUNCTIONS
async function submitFarmer(op) {
  const data = getFormData('farmerForm');
  let query;

  // âœ… Always use mutation, even for read
  if (op === 'read') {
    if (!data.productId) {
      showFlash('Product ID is required to load data!', 'warning');
      return;
    }

    query = `
      mutation {
        operateAllUserData(
          operation: "${op}",
          input: [
            { userProductInfo: { productId: "${data.productId}" } }
          ]
        ) {
          userProductInfo {
            farmerUniqueId productId productName productPrice productDesc
            productRating locationDetail productImage productQuantityAvaliable
            productQuantityUsed minOrderReq MultipleOrderRequest live response status
          }
        }
      }
    `;
  } else {
    query = `
      mutation {
        operateAllUserData(
          operation: "${op}",
          input: [
            { userProductInfo: {
              farmerUniqueId: "${data.farmerUniqueId || ''}",
              productId: "${data.productId || ''}",
              productName: "${data.productName || ''}",
              productPrice: ${data.productPrice || 0},
              productDesc: "${data.productDesc || ''}",
              productRating: ${data.productRating || 0},
              locationDetail: "${data.locationDetail || ''}",
              productImage: "${data.productImage || ''}",
              productQuantityAvaliable: ${data.productQuantityAvaliable || 0},
              productQuantityUsed: ${data.productQuantityUsed || 0},
              minOrderReq: ${data.minOrderReq || 0},
              MultipleOrderRequest: ${data.MultipleOrderRequest || 0},
              live: "${data.live || ''}"
            } }
          ]
        ) {
          userProductInfo {
            farmerUniqueId productId productName productPrice productDesc
            productRating locationDetail productImage productQuantityAvaliable
            productQuantityUsed minOrderReq MultipleOrderRequest live response status
          }
        }
      }
    `;
  }

  try {
    const res = await fetch('/graphql-data', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ query })
    });

    const result = await res.json();
    const userData = result?.data?.operateAllUserData?.[0]?.userProductInfo?.[0];

    if (userData?.status === 200) {
      if (op === 'read') fillForm('farmerForm', userData);
      showFlash(userData.response || `Farmer ${op} successful!`, 'success');
    } else {
      showFlash(userData?.response || `Farmer ${op} failed!`, 'danger');
    }

    console.log(result);
  } catch (err) {
    console.error(err);
    showFlash(`Farmer ${op} failed`, 'danger');
  }
}


// SHOPKEEPER FUNCTIONS
async function submitShop(op) {
  const data = getFormData('shopForm');
  let query;

  // Only send orderId for read
  if (op === 'read') {
    if (!data.orderId) {
      showFlash('Order ID is required to load data!', 'warning');
      return;
    }

    query = `
      mutation {
        operateAllUserData(
          operation: "${op}",
          input: [
            { userOrderInfo: { orderId: "${data.orderId}" } }
          ]
        ) {
          userOrderInfo {
            orderId shopUniqueId paymentId totalAmount accoragement paymentStatus
            paymentMethod shipmentStatus shipmentInfo quantityGetting productId response status
          }
        }
      }
    `;
  } 
  else {
    query = `
      mutation {
        operateAllUserData(
          operation: "${op}",
          input: [
            { userOrderInfo: {
              orderId : "${data.orderId}",
              shopUniqueId : "${data.shopUniqueId}",
              paymentId : "${data.paymentId}",
              totalAmount : ${data.totalAmount},
              accoragement : "${data.accoragement}",
              paymentStatus : "${data.paymentStatus}",
              paymentMethod : "${data.paymentMethod}",
              shipmentStatus : "${data.shipmentStatus}",
              shipmentInfo : "${data.shipmentInfo}",
              quantityGetting : ${data.quantityGetting},
              productId : "${data.productId}"
            } }
          ]
        ) {
          userOrderInfo {
            orderId shopUniqueId paymentId totalAmount accoragement paymentStatus
            paymentMethod shipmentStatus shipmentInfo quantityGetting productId response status
          }
        }
      }
    `;
  }

  try {
    const res = await fetch('/graphql-data', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({"query": query })
    });

    const result = await res.json();
    const userData = result?.data?.operateAllUserData?.[0]?.userOrderInfo?.[0];

    if (userData?.status === 200) {
      if (op === 'read') fillForm('shopForm', userData);
      showFlash(userData.response || `Shopkeeper ${op} successful!`, 'success');
    } else {
      showFlash(userData?.response || `Shopkeeper ${op} failed!`, 'danger');
    }

    console.log(result);
  } catch (err) {
    console.error(err);
    showFlash(`Shopkeeper ${op} failed`, 'danger');
  }
}
</script>

</body>
</html>
